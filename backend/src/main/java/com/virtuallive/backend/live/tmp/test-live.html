<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç›´æ’­ç³»ç»Ÿå…¨åŠŸèƒ½æµ‹è¯•æ§åˆ¶å°</title>
    <!-- å¼•å…¥ SockJS å’Œ STOMP åº“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 1000px; margin: 0 auto; padding: 20px; background-color: #f4f6f9; }
        h1 { text-align: center; color: #333; }
        h3 { margin-top: 0; color: #444; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
        h4 { margin: 10px 0 5px; color: #666; font-size: 0.9em; }

        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .column { flex: 1; min-width: 300px; }

        .box { background: white; padding: 15px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .box.admin { border-left: 5px solid #ff9800; } /* ç®¡ç†å‘˜åŒºåŸŸç”¨æ©™è‰²æ ‡è®° */
        .box.viewer { border-left: 5px solid #4caf50; } /* è§‚ä¼—åŒºåŸŸç”¨ç»¿è‰²æ ‡è®° */

        .log { background: #1e1e1e; color: #00ff00; font-family: monospace; height: 400px; overflow-y: scroll; padding: 10px; border-radius: 5px; border: 1px solid #333; font-size: 13px; }

        .input-group { margin-bottom: 8px; }
        label { display: inline-block; width: 70px; font-size: 0.9em; font-weight: bold; }
        input, select { padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        button { cursor: pointer; padding: 6px 12px; border: none; border-radius: 4px; background-color: #007bff; color: white; transition: 0.2s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }
        button.danger { background-color: #dc3545; }
        button.danger:hover { background-color: #a71d2a; }

        .status { font-weight: bold; margin-left: 10px; }
        .json-result { background: #eee; padding: 5px; font-size: 12px; margin-top: 5px; white-space: pre-wrap; max-height: 100px; overflow-y: auto; }
    </style>
</head>
<body>

<h1>ğŸ“¡ ç›´æ’­ API ç»ˆææµ‹è¯•å°</h1>

<!-- å…¨å±€é…ç½® -->
<div class="box">
    <h3>ğŸ› ï¸ å…¨å±€ç¯å¢ƒé…ç½®</h3>
    <div class="input-group">
        <label>åç«¯åœ°å€:</label> <input type="text" id="baseUrl" value="http://localhost:8081" style="width: 200px;">
        <label>ç›´æ’­é—´ID:</label> <input type="number" id="roomIdInput" value="101" style="width: 60px;">
    </div>
    <div class="input-group">
        <label>Token:</label> <input type="text" id="tokenInput" value="admin-token-123" style="width: 250px;" placeholder="admin-token-123 ç”¨äºæµ‹è¯•ä¸»æ’­åŠŸèƒ½">
        <span style="font-size: 12px; color: #666;">(æ³¨: ä½¿ç”¨ admin-token-123 æ¨¡æ‹Ÿä¸»æ’­/æˆ¿ç®¡ï¼Œæ™®é€šç”¨æˆ·å¯ç”¨å…¶ä»–å­—ç¬¦ä¸²)</span>
    </div>
</div>

<div class="container">
    <!-- å·¦ä¾§ï¼šWebSocket äº’åŠ¨åŒº -->
    <div class="column">
        <div class="box viewer">
            <h3>ğŸ’¬ è§‚ä¼—äº’åŠ¨ (WebSocket)</h3>
            <div class="input-group">
                <button onclick="connect()">ğŸ”Œ è¿æ¥ WebSocket</button>
                <button onclick="disconnect()" disabled id="btnDisconnect" class="danger">âŒ æ–­å¼€</button>
                <span id="wsStatus" class="status" style="color: red">æœªè¿æ¥</span>
            </div>

            <hr>

            <h4>æ™®é€šå¼¹å¹• (Chat)</h4>
            <div class="input-group">
                <input type="text" id="msgContent" value="ä¸»æ’­å¥½å¸…ï¼" placeholder="å†…å®¹">
                <input type="color" id="msgColor" value="#000000">
                <button onclick="sendChat()" disabled id="btnSendChat">å‘é€</button>
            </div>

            <h4>ç¤¼ç‰© (Gift)</h4>
            <div class="input-group">
                <input type="text" id="giftName" value="ç«ç®­" placeholder="ç¤¼ç‰©å" style="width: 80px;">
                <input type="number" id="giftCount" value="1" style="width: 40px;" placeholder="æ•°é‡">
                <input type="number" id="giftPrice" value="100" style="width: 60px;" placeholder="å•ä»·">
                <button onclick="sendGift()" disabled id="btnSendGift">ğŸ é€ç¤¼</button>
            </div>

            <h4>é†’ç›®ç•™è¨€ (SC)</h4>
            <div class="input-group">
                <input type="number" id="scPrice" value="50" style="width: 60px;" placeholder="é‡‘é¢">
                <input type="text" id="scContent" value="åŠ æ²¹åŠ æ²¹ï¼" placeholder="SCå†…å®¹">
                <button onclick="sendSC()" disabled id="btnSendSC" style="background-color: #e91e63;">ğŸ’– å‘é€SC</button>
            </div>
        </div>

        <div class="box viewer">
            <h3>ğŸ“Š è§‚ä¼—æŸ¥è¯¢ API</h3>
            <div class="input-group">
                <button onclick="getRoomInfo()">æŸ¥è¯¢ç›´æ’­é—´ä¿¡æ¯ (Info)</button>
            </div>
            <div class="input-group">
                <select id="leaderboardType">
                    <option value="SESSION">æœ¬åœºæ¦œ (SESSION)</option>
                    <option value="DAY">æ—¥æ¦œ (DAY)</option>
                    <option value="WEEK">å‘¨æ¦œ (WEEK)</option>
                </select>
                <button onclick="getLeaderboard()">æŸ¥è¯¢æ‰“èµæ¦œå•</button>
            </div>
            <div id="publicApiResult" class="json-result">ç­‰å¾…æŸ¥è¯¢...</div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šç®¡ç†åŒº -->
    <div class="column">
        <div class="box admin">
            <h3>ğŸ¥ ä¸»æ’­ç®¡ç† API (éœ€é‰´æƒ)</h3>
            <div class="input-group">
                <button onclick="getManagerInfo()">è·å–æ¨æµä¿¡æ¯ & Key</button>
                <button onclick="resetStreamKey()" class="danger">é‡ç½®æ¨æµç </button>
            </div>

            <h4>æ›´æ–°æˆ¿é—´è®¾ç½®</h4>
            <div class="input-group">
                <input type="text" id="roomTitle" placeholder="æ–°æ ‡é¢˜" value="ä»Šæ™šåƒé¸¡å¤§å‰å¤§åˆ©">
                <input type="text" id="roomDesc" placeholder="æ–°ç®€ä»‹" value="æ–°äººæ±‚å…³æ³¨">
                <button onclick="updateRoom()">æ›´æ–°è®¾ç½®</button>
            </div>
            <div id="managerApiResult" class="json-result">ç­‰å¾…æ“ä½œ...</div>
        </div>

        <div class="box admin">
            <h3>ğŸ›¡ï¸ æˆ¿ç®¡æƒé™ API</h3>
            <h4>ç¦è¨€ç”¨æˆ·</h4>
            <div class="input-group">
                <input type="number" id="muteUserId" placeholder="ç”¨æˆ·ID(å¦‚88)" value="88" style="width: 80px;">
                <input type="number" id="muteDuration" placeholder="ç§’æ•°" value="60" style="width: 60px;">
                <button onclick="muteUser()" class="danger">ğŸš« ç¦è¨€</button>
            </div>

            <h4>åˆ é™¤å¼¹å¹•</h4>
            <div class="input-group">
                <input type="number" id="delDanmakuId" placeholder="å¼¹å¹•ID" style="width: 80px;">
                <button onclick="deleteDanmaku()" class="danger">ğŸ—‘ï¸ åˆ é™¤</button>
            </div>
            <div id="adminApiResult" class="json-result">ç­‰å¾…æ“ä½œ...</div>
        </div>
    </div>
</div>

<h3>ğŸ“ å®æ—¶æ—¥å¿—</h3>
<div class="log" id="logArea"></div>

<script>
    let stompClient = null;

    // --- è¾…åŠ©å‡½æ•° ---
    function log(msg) {
        const div = document.getElementById('logArea');
        div.innerHTML += `<div>[${new Date().toLocaleTimeString()}] ${msg}</div>`;
        div.scrollTop = div.scrollHeight;
        console.log(msg);
    }

    function getBaseUrl() { return document.getElementById('baseUrl').value; }
    function getRoomId() { return document.getElementById('roomIdInput').value; }
    function getToken() { return document.getElementById('tokenInput').value; }

    // é€šç”¨ Fetch å°è£…
    async function apiCall(endpoint, method = 'GET', body = null, resultDivId = null) {
        const url = `${getBaseUrl()}${endpoint}`;
        const headers = {
            'Content-Type': 'application/json',
            'token': getToken() // å…³é”®ï¼šå°† Token æ”¾å…¥ Header
        };

        log(`ğŸ“¡ HTTP ${method} ${url}`);

        try {
            const options = { method, headers };
            if (body) options.body = JSON.stringify(body);

            const res = await fetch(url, options);
            const text = await res.text();

            let data;
            try { data = JSON.parse(text); } catch (e) { data = text; }

            const display = typeof data === 'object' ? JSON.stringify(data, null, 2) : data;

            if (resultDivId) {
                document.getElementById(resultDivId).innerText = `Status: ${res.status}\n${display}`;
            }

            if (res.ok) {
                log(`âœ… è¯·æ±‚æˆåŠŸ: ${endpoint}`);
            } else {
                log(`âŒ è¯·æ±‚å¤±è´¥ (${res.status}): ${endpoint}`);
            }
            return data;
        } catch (e) {
            log(`ğŸ’¥ ç½‘ç»œé”™è¯¯: ${e.message}`);
            if (resultDivId) document.getElementById(resultDivId).innerText = `Error: ${e.message}`;
        }
    }

    // --- 1. WebSocket åŠŸèƒ½ ---
    function connect() {
        const roomId = getRoomId();
        const url = `${getBaseUrl()}/ws-live`; // SockJS ç«¯ç‚¹

        log(`ğŸ”Œ æ­£åœ¨è¿æ¥ SockJS: ${url} ...`);
        const socket = new SockJS(url);
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // å…³é—­ STOMP è°ƒè¯•æ—¥å¿—

        const headers = { 'token': getToken() };

        stompClient.connect(headers, function (frame) {
            log('ğŸŸ¢ STOMP è¿æ¥å»ºç«‹æˆåŠŸ!');
            updateWsStatus(true);

            // è®¢é˜…å¼¹å¹•
            const topic = `/topic/danmaku/${roomId}`;
            stompClient.subscribe(topic, function (message) {
                log(`ğŸ“© æ”¶åˆ°å¹¿æ’­: ${message.body}`);
            });
            log(`ğŸ‘‚ å·²è®¢é˜…: ${topic}`);

        }, function (error) {
            log('ğŸ”´ è¿æ¥å¤±è´¥: ' + error);
            updateWsStatus(false);
        });
    }

    function disconnect() {
        if (stompClient) stompClient.disconnect();
        updateWsStatus(false);
        log("ğŸ”´ å·²æ–­å¼€è¿æ¥");
    }

    function sendPayload(type, additionalData) {
        if (!stompClient) return log("âš ï¸ è¯·å…ˆè¿æ¥ WebSocket");

        const payload = {
            type: type,
            roomId: parseInt(getRoomId()),
            ...additionalData
        };

        // Header ä¹Ÿè¦å¸¦ Tokenï¼Œè™½ç„¶è¿æ¥æ—¶å¸¦äº†ï¼Œä½†æŸäº›åç«¯å®ç°å¯èƒ½ä¾èµ–æ¯æ¬¡å‘é€çš„ Header
        stompClient.send("/app/send-danmaku", { 'token': getToken() }, JSON.stringify(payload));
        log(`ğŸ“¤ å‘é€ [${type}]: ${JSON.stringify(payload)}`);
    }

    function sendChat() {
        sendPayload('CHAT', {
            content: document.getElementById('msgContent').value,
            color: document.getElementById('msgColor').value
        });
    }

    function sendGift() {
        sendPayload('GIFT', {
            giftName: document.getElementById('giftName').value,
            giftCount: parseInt(document.getElementById('giftCount').value),
            giftPrice: parseFloat(document.getElementById('giftPrice').value),
            content: ''
        });
    }

    function sendSC() {
        sendPayload('SC', {
            giftPrice: parseFloat(document.getElementById('scPrice').value),
            content: document.getElementById('scContent').value
        });
    }

    function updateWsStatus(connected) {
        const el = document.getElementById('wsStatus');
        el.innerText = connected ? "å·²è¿æ¥" : "æœªè¿æ¥";
        el.style.color = connected ? "green" : "red";
        document.getElementById('btnDisconnect').disabled = !connected;
        document.getElementById('btnSendChat').disabled = !connected;
        document.getElementById('btnSendGift').disabled = !connected;
        document.getElementById('btnSendSC').disabled = !connected;
    }


    // --- 2. è§‚ä¼—æŸ¥è¯¢ API ---
    function getRoomInfo() {
        apiCall(`/api/live/rooms/${getRoomId()}`, 'GET', null, 'publicApiResult');
    }

    function getLeaderboard() {
        const type = document.getElementById('leaderboardType').value;
        apiCall(`/api/live/rooms/${getRoomId()}/stats/leaderboard?type=${type}`, 'GET', null, 'publicApiResult');
    }


    // --- 3. ä¸»æ’­ç®¡ç† API ---
    function getManagerInfo() {
        apiCall(`/api/live/rooms/${getRoomId()}/manager/info`, 'GET', null, 'managerApiResult');
    }

    function resetStreamKey() {
        if(!confirm("ç¡®å®šè¦é‡ç½®æ¨æµç å—ï¼Ÿä¼šå¯¼è‡´å½“å‰æ¨æµä¸­æ–­ï¼")) return;
        apiCall(`/api/live/rooms/${getRoomId()}/manager/stream-key`, 'POST', {}, 'managerApiResult');
    }

    function updateRoom() {
        const body = {
            title: document.getElementById('roomTitle').value,
            description: document.getElementById('roomDesc').value,
            coverUrl: "http://example.com/cover.jpg",
            category: "General"
        };
        apiCall(`/api/live/rooms/${getRoomId()}/manager/update`, 'POST', body, 'managerApiResult');
    }


    // --- 4. æˆ¿ç®¡æƒé™ API ---
    function muteUser() {
        const body = {
            userId: parseInt(document.getElementById('muteUserId').value),
            durationSeconds: parseInt(document.getElementById('muteDuration').value)
        };
        apiCall(`/api/live/rooms/${getRoomId()}/manager/mute`, 'POST', body, 'adminApiResult');
    }

    function deleteDanmaku() {
        const id = document.getElementById('delDanmakuId').value;
        if (!id) return alert("è¯·è¾“å…¥å¼¹å¹•ID");
        apiCall(`/api/live/rooms/${getRoomId()}/manager/danmaku/${id}`, 'DELETE', null, 'adminApiResult');
    }

</script>
</body>
</html>