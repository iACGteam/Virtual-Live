<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>VirtualLive ç›´æ’­é—´ + ç¤¼ç‰©ç‰¹æ•ˆ</title>
    <script src="https://unpkg.com/flv.js/dist/flv.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; background: #f0f2f5; }
        .container { display: flex; width: 1100px; margin: 0 auto; background: #fff; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden; }
        
        /* å·¦ä¾§è§†é¢‘åŒº */
        .video-box { flex: 3; background: #000; position: relative; height: 500px; }
        video { width: 100%; height: 100%; object-fit: contain; }
        
        /* å¼¹å¹•è¦†ç›–å±‚ */
        .danmaku-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 40%; pointer-events: none; overflow: hidden; }
        .flying-text { position: absolute; color: #fff; font-size: 24px; font-weight: bold; text-shadow: 2px 2px 4px rgba(0,0,0,0.8); white-space: nowrap; animation: fly 10s linear forwards; }
        @keyframes fly { from { left: 100%; transform: translateX(0); } to { left: 0; transform: translateX(-100%); } }

        /* ç¤¼ç‰©ç‰¹æ•ˆå±‚ */
        .gift-effect-layer { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            pointer-events: none; display: flex; justify-content: center; align-items: center;
            z-index: 99;
        }
        /* ç«ç®­åŠ¨ç”» */
        .rocket-anim { font-size: 100px; animation: rocket-fly 2s ease-in-out forwards; position: absolute; bottom: -100px; }
        @keyframes rocket-fly { 
            0% { bottom: -100px; transform: scale(0.5); opacity: 0; } 
            20% { bottom: 20%; transform: scale(1.2); opacity: 1; } 
            80% { bottom: 60%; transform: scale(1.2); opacity: 1; } 
            100% { bottom: 120%; transform: scale(0.5); opacity: 0; } 
        }

        /* å³ä¾§èŠå¤©åŒº */
        .chat-box { flex: 1; background: #f9f9f9; display: flex; flex-direction: column; border-left: 1px solid #eee; }
        .chat-header { padding: 15px; background: #fff; font-weight: bold; border-bottom: 1px solid #eee; color: #333; }
        #msg-list { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; }
        
        .msg-item { margin-bottom: 8px; line-height: 1.5; word-break: break-all; }
        .msg-user { color: #1890ff; font-weight: 600; margin-right: 4px; cursor: pointer; }
        .msg-content { color: #333; }
        
        /* ç¤¼ç‰©æ¶ˆæ¯æ ·å¼ */
        .msg-item.gift-msg { background: #fffbe6; border: 1px solid #ffe58f; padding: 5px; border-radius: 4px; text-align: center; }
        .msg-item.gift-msg .msg-content { color: #faad14; font-weight: bold; }

        /* åº•éƒ¨æ“ä½œåŒº */
        .action-area { padding: 10px; background: #fff; border-top: 1px solid #eee; }
        .gift-panel { display: flex; gap: 10px; margin-bottom: 10px; }
        .gift-btn { flex: 1; border: 1px solid #eee; background: #fff; padding: 8px; border-radius: 4px; cursor: pointer; transition: all 0.3s; text-align: center; }
        .gift-btn:hover { background: #e6f7ff; border-color: #1890ff; color: #1890ff; }
        
        .input-group { display: flex; gap: 8px; }
        input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; outline: none; }
        input:focus { border-color: #1890ff; }
        .send-btn { padding: 8px 20px; background: #1890ff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .send-btn:hover { background: #40a9ff; }
    </style>
</head>
<body>

<div class="container">
    <div class="video-box">
        <video id="videoElement" controls autoplay muted></video>
        <div id="danmaku-overlay" class="danmaku-overlay"></div>
        <!-- ç¤¼ç‰©ç‰¹æ•ˆå®¹å™¨ -->
        <div id="gift-effect-layer" class="gift-effect-layer"></div>
    </div>

    <div class="chat-box">
        <div class="chat-header">ç›´æ’­äº’åŠ¨åŒº (Mockç‰ˆ)</div>
        <div id="msg-list"></div>
        
        <div class="action-area">
            <!-- ç¤¼ç‰©é¢æ¿ -->
            <div class="gift-panel">
                <div class="gift-btn" onclick="sendGift('flower')">ğŸŒ¸ é€é²œèŠ± (å…è´¹)</div>
                <div class="gift-btn" onclick="sendGift('rocket')">ğŸš€ é€ç«ç®­ (100å¸)</div>
            </div>
            
            <!-- å¼¹å¹•è¾“å…¥ -->
            <div class="input-group">
                <input type="text" id="danmakuInput" placeholder="å‘ä¸ªå¼¹å¹•..." onkeypress="if(event.keyCode==13) sendMsg()">
                <button class="send-btn" onclick="sendMsg()">å‘é€</button>
            </div>
        </div>
    </div>
</div>

<script>
    // 1. è§†é¢‘æ’­æ”¾ (OBSæ¨æµåå¯è§)
    if (flvjs.isSupported()) {
        var videoElement = document.getElementById('videoElement');
        var flvPlayer = flvjs.createPlayer({
            type: 'flv',
            // url: 'http://localhost:8088/live/my_secret_key_2025.flv'
            url: 'http://localhost:8088/live/room_101_04151186.flv'
        });
        flvPlayer.attachMediaElement(videoElement);
        flvPlayer.load();
        flvPlayer.play();
    }

    // 2. WebSocket é€»è¾‘
    var stompClient = null;
    var roomId = 1;
    // æ¨¡æ‹Ÿç™»å½• token
    var myToken = "user-token-666";
    // var myToken = "admin-token-123";
    // var myToken = "";

    function connect() {
        var socket = new SockJS('http://localhost:8080/ws-live');
        stompClient = Stomp.over(socket);
        stompClient.debug = null; // å…³é—­è°ƒè¯•æ—¥å¿—

        stompClient.connect({}, function (frame) {
            console.log('WebSocket Connected');
            appendSystemMsg("è¿æ¥æˆåŠŸï¼æ¬¢è¿æ¥åˆ°ç›´æ’­é—´");
            
            stompClient.subscribe('/topic/danmaku/' + roomId, function (response) {
                var msg = JSON.parse(response.body);
                handleMessage(msg);
            });
        });
    }

    // å‘é€æ™®é€šå¼¹å¹•
    function sendMsg() {
        var input = document.getElementById("danmakuInput");
        var content = input.value.trim();
        if (!content) return;
        
        sendPayload({
            'roomId': roomId,
            'type': 'CHAT',
            'content': content
        });
        input.value = "";
    }

    // å‘é€ç¤¼ç‰©
    function sendGift(giftName) {
        // è¿™é‡Œå¯ä»¥åŠ ä¸ªç¡®è®¤å¼¹çª—
        // if(!confirm("ç¡®è®¤èŠ±è´¹é‡‘å¸å‘é€ " + giftName + " å—ï¼Ÿ")) return;

        sendPayload({
            'roomId': roomId,
            'type': 'GIFT',
            'giftName': giftName,
            'giftCount': 1
        });
    }

    function sendPayload(payload) {
        if (stompClient && stompClient.connected) {
            stompClient.send("/app/send-danmaku", { "token": myToken }, JSON.stringify(payload));
        } else {
            alert("æœªè¿æ¥åˆ°æœåŠ¡å™¨");
        }
    }

    // å¤„ç†æ¥æ”¶åˆ°çš„æ¶ˆæ¯
    function handleMessage(msg) {
        var list = document.getElementById("msg-list");
        var div = document.createElement("div");
        
        if (msg.type === 'GIFT') {
            // === å¤„ç†ç¤¼ç‰©æ¶ˆæ¯ ===
            div.className = "msg-item gift-msg";
            div.innerHTML = `ğŸ‰ <span class="msg-user">${msg.senderName}</span> ${msg.content}`;
            
            // è§¦å‘å…¨å±åŠ¨ç”»
            playGiftAnimation(msg.giftName);
        } else {
            // === å¤„ç†æ™®é€šæ¶ˆæ¯ ===
            div.className = "msg-item";
            div.innerHTML = `<span class="msg-user">${msg.senderName}:</span><span class="msg-content">${msg.content}</span>`;
            // é£˜å¼¹å¹•
            shootDanmaku(msg.content);
        }
        
        list.appendChild(div);
        list.scrollTop = list.scrollHeight;
    }

    // æ’­æ”¾ CSS åŠ¨ç”»
    function playGiftAnimation(giftName) {
        var layer = document.getElementById("gift-effect-layer");
        var el = document.createElement("div");
        
        if (giftName === 'rocket') {
            el.className = "rocket-anim";
            el.innerHTML = "ğŸš€";
        } else if (giftName === 'flower') {
            el.className = "rocket-anim"; // å¤ç”¨åŠ¨ç”»ï¼Œä½†æ¢ä¸ªå›¾æ ‡
            el.innerHTML = "ğŸŒ¸";
        }
        
        layer.appendChild(el);
        // åŠ¨ç”»ç»“æŸåç§»é™¤
        setTimeout(() => el.remove(), 2000);
    }

    // é£˜å¼¹å¹•æ•ˆæœ
    function shootDanmaku(text) {
        var overlay = document.getElementById("danmaku-overlay");
        var span = document.createElement("span");
        span.className = "flying-text";
        span.innerText = text;
        span.style.top = Math.floor(Math.random() * 80) + "%"; 
        overlay.appendChild(span);
        span.addEventListener("animationend", () => span.remove());
    }

    function appendSystemMsg(text) {
        var list = document.getElementById("msg-list");
        var div = document.createElement("div");
        div.style.textAlign = "center";
        div.style.color = "#999";
        div.style.fontSize = "12px";
        div.style.margin = "10px 0";
        div.innerText = text;
        list.appendChild(div);
    }

    connect();
</script>
</body>
</html>